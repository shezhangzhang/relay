<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Metric protocol, aggregation and processing for Sentry."><meta name="keywords" content="rust, rustlang, rust-lang, relay_metrics"><title>relay_metrics - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" href="../normalize.css"><link rel="stylesheet" href="../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" href="../ayu.css" disabled><link rel="stylesheet" href="../dark.css" disabled><link rel="stylesheet" href="../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../storage.js"></script><script defer src="../crates.js"></script><script defer src="../main.js"></script><noscript><link rel="stylesheet" href="../noscript.css"></noscript><link rel="icon" href="https://raw.githubusercontent.com/getsentry/relay/master/artwork/relay-icon.png"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../relay_metrics/index.html"><div class="logo-container"><img src="https://raw.githubusercontent.com/getsentry/relay/master/artwork/relay-icon.png" alt="logo"></div></a><h2 class="location"></h2></nav><nav class="sidebar"><a class="sidebar-logo" href="../relay_metrics/index.html"><div class="logo-container">
                    <img src="https://raw.githubusercontent.com/getsentry/relay/master/artwork/relay-icon.png" alt="logo"></div></a><h2 class="location"><a href="#">Crate relay_metrics</a></h2><div class="sidebar-elems"><div class="block"><ul><li class="version">Version 22.11.0</li><li><a id="all-types" href="all.html">All Items</a></li></ul></div><section><div class="block"><ul><li><a href="#macros">Macros</a></li><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li><li><a href="#traits">Traits</a></li><li><a href="#types">Type Definitions</a></li></ul></div></section></div></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../relay_metrics/index.html">
                        <img src="https://raw.githubusercontent.com/getsentry/relay/master/artwork/relay-icon.png" alt="logo"></a><nav class="sub"><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><button type="button">?</button></div><div id="settings-menu" tabindex="-1"><a href="../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../wheel.svg"></a></div></div></form></nav></div><section id="main-content" class="content"><div class="main-heading"><h1 class="fqn"><span class="in-band">Crate <a class="mod" href="#">relay_metrics</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../clipboard.svg" width="19" height="18" alt="Copy item path"></button></span></h1><span class="out-of-band"><a class="srclink" href="../src/relay_metrics/lib.rs.html#1-108">source</a> · <a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span></div><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Metric protocol, aggregation and processing for Sentry.</p>
<p>Metrics are high-volume values sent from Sentry clients, integrations, or extracted from errors
and transactions, that can be aggregated and queried over large time windows. As opposed to rich
errors and transactions, metrics carry relatively little context information in tags with low
cardinality.</p>
<h2 id="protocol"><a href="#protocol">Protocol</a></h2>
<p>Clients submit metrics in a <a href="struct.Metric.html">text-based protocol</a> based on StatsD. A sample submission
looks like this:</p>
<div class="example-wrap"><pre class="language-text"><code>endpoint.response_time@millisecond:57|d|#route:user_index
endpoint.hits:1|c|#route:user_index</code></pre></div>
<p>The metric type is part of its signature just like the unit. Therefore, it is allowed to reuse a
metric name for multiple metric types, which will result in multiple metrics being recorded.</p>
<h2 id="metric-envelopes"><a href="#metric-envelopes">Metric Envelopes</a></h2>
<p>To send one or more metrics to Relay, the raw protocol is enclosed in an envelope item of type
<code>metrics</code>:</p>
<div class="example-wrap"><pre class="language-text"><code>{}
{&quot;type&quot;: &quot;metrics&quot;, &quot;timestamp&quot;: 1615889440, ...}
endpoint.response_time@millisecond:57|d|#route:user_index
...</code></pre></div>
<p>Note that the name format used in the statsd protocol is different from the MRI: Metric names
are not prefixed with <code>&lt;ty&gt;:</code> as the type is somewhere else in the protocol.</p>
<p>The timestamp in the item header is used to send backdated metrics. If it is omitted,
the <code>received</code> time of the envelope is assumed.</p>
<h2 id="aggregation"><a href="#aggregation">Aggregation</a></h2>
<p>Relay accumulates all metrics in <a href="struct.Bucket.html">time buckets</a> before sending them onwards. Aggregation
is handled by the <a href="enum.Aggregator.html" title="Aggregator"><code>Aggregator</code></a>, which should be created once for the entire system. It flushes
aggregates in regular intervals, either shortly after their original time window has passed or
with a debounce delay for backdated submissions.</p>
<p><strong>Warning</strong>: With chained Relays submission delays accumulate.</p>
<p>Aggregate buckets are encoded in JSON with the following schema:</p>
<div class="example-wrap"><pre class="language-json"><code>[
  {
    &quot;name&quot;: &quot;endpoint.response_time&quot;,
    &quot;unit&quot;: &quot;millisecond&quot;,
    &quot;value&quot;: [36, 49, 57, 68],
    &quot;type&quot;: &quot;d&quot;,
    &quot;timestamp&quot;: 1615889440,
    &quot;width&quot;: 10,
    &quot;tags&quot;: {
      &quot;route&quot;: &quot;user_index&quot;
    }
  },
  {
    &quot;name&quot;: &quot;endpoint.hits&quot;,
    &quot;value&quot;: 4,
    &quot;type&quot;: &quot;c&quot;,
    &quot;timestamp&quot;: 1615889440,
    &quot;width&quot;: 10,
    &quot;tags&quot;: {
      &quot;route&quot;: &quot;user_index&quot;
    }
  }
]</code></pre></div><h2 id="ingestion"><a href="#ingestion">Ingestion</a></h2>
<p>Processing Relays write aggregate buckets into the ingestion Kafka stream. The schema is similar
to the aggregation payload, with the addition of scoping information. Each bucket is sent in a
separate message:</p>
<div class="example-wrap"><pre class="language-json"><code>{
  &quot;org_id&quot;: 1,
  &quot;project_id&quot;: 42,
  &quot;name&quot;: &quot;endpoint.response_time&quot;,
  &quot;unit&quot;: &quot;millisecond&quot;,
  &quot;value&quot;: [36, 49, 57, 68],
  &quot;type&quot;: &quot;d&quot;,
  &quot;timestamp&quot;: 1615889440,
  &quot;tags&quot;: {
    &quot;route&quot;: &quot;user_index&quot;
  }
}</code></pre></div></div></details><h2 id="macros" class="small-section-header"><a href="#macros">Macros</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="macro" href="macro.dist.html" title="relay_metrics::dist macro">dist</a></div><div class="item-right docblock-short">Creates a <a href="struct.DistributionValue.html" title="DistributionValue"><code>DistributionValue</code></a> containing the given arguments.</div></div></div><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.AcceptsMetrics.html" title="relay_metrics::AcceptsMetrics struct">AcceptsMetrics</a></div><div class="item-right docblock-short">Check whether the aggregator has not (yet) exceeded its total limits. Used for health checks.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.AggregateMetricsError.html" title="relay_metrics::AggregateMetricsError struct">AggregateMetricsError</a></div><div class="item-right docblock-short">Any error that may occur during aggregation.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.AggregatorConfig.html" title="relay_metrics::AggregatorConfig struct">AggregatorConfig</a></div><div class="item-right docblock-short">Parameters used by the <a href="struct.AggregatorService.html" title="AggregatorService"><code>AggregatorService</code></a>.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.AggregatorService.html" title="relay_metrics::AggregatorService struct">AggregatorService</a></div><div class="item-right docblock-short">A collector of <a href="struct.Metric.html" title="Metric"><code>Metric</code></a> submissions.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.Bucket.html" title="relay_metrics::Bucket struct">Bucket</a></div><div class="item-right docblock-short">An aggregation of metric values by the <a href="enum.Aggregator.html" title="Aggregator"><code>Aggregator</code></a>.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.CustomUnit.html" title="relay_metrics::CustomUnit struct">CustomUnit</a></div><div class="item-right docblock-short">Custom user-defined units without builtin conversion.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.DistributionIter.html" title="relay_metrics::DistributionIter struct">DistributionIter</a></div><div class="item-right docblock-short">An iterator over distribution entries in a <a href="struct.DistributionValue.html" title="DistributionValue"><code>DistributionValue</code></a>.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.DistributionValue.html" title="relay_metrics::DistributionValue struct">DistributionValue</a></div><div class="item-right docblock-short">A distribution of values within a <a href="struct.Bucket.html" title="Bucket"><code>Bucket</code></a>.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.DistributionValuesIter.html" title="relay_metrics::DistributionValuesIter struct">DistributionValuesIter</a></div><div class="item-right docblock-short">An iterator over all individual values in a <a href="struct.DistributionValue.html" title="DistributionValue"><code>DistributionValue</code></a>.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.FlushBuckets.html" title="relay_metrics::FlushBuckets struct">FlushBuckets</a></div><div class="item-right docblock-short">A message containing a vector of buckets to be flushed.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.GaugeValue.html" title="relay_metrics::GaugeValue struct">GaugeValue</a></div><div class="item-right docblock-short">A snapshot of values within a <a href="struct.Bucket.html" title="Bucket"><code>Bucket</code></a>.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.HashedBucket.html" title="relay_metrics::HashedBucket struct">HashedBucket</a></div><div class="item-right docblock-short">A Bucket and its hashed key.
This is cheaper to pass around than a (BucketKey, Bucket) pair.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.InsertMetrics.html" title="relay_metrics::InsertMetrics struct">InsertMetrics</a></div><div class="item-right docblock-short">A message containing a list of <a href="struct.Metric.html" title="Metric"><code>Metric</code></a>s to be inserted into the aggregator.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.MergeBuckets.html" title="relay_metrics::MergeBuckets struct">MergeBuckets</a></div><div class="item-right docblock-short">A message containing a list of <a href="struct.Bucket.html" title="Bucket"><code>Bucket</code></a>s to be inserted into the aggregator.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.Metric.html" title="relay_metrics::Metric struct">Metric</a></div><div class="item-right docblock-short">A single metric value representing the payload sent from clients.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.MetricResourceIdentifier.html" title="relay_metrics::MetricResourceIdentifier struct">MetricResourceIdentifier</a></div><div class="item-right docblock-short">A metric name parsed as MRI, a naming scheme which includes most of the metric’s bucket key
(excl. timestamp and tags).</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.ParseBucketError.html" title="relay_metrics::ParseBucketError struct">ParseBucketError</a></div><div class="item-right docblock-short">Error returned when parsing or serializing a <a href="struct.Bucket.html" title="Bucket"><code>Bucket</code></a>.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.ParseMetricError.html" title="relay_metrics::ParseMetricError struct">ParseMetricError</a></div><div class="item-right docblock-short">An error returned by <a href="struct.Metric.html#method.parse" title="Metric::parse"><code>Metric::parse</code></a> and <a href="struct.Metric.html#method.parse_all" title="Metric::parse_all"><code>Metric::parse_all</code></a>.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.ParseMetricUnitError.html" title="relay_metrics::ParseMetricUnitError struct">ParseMetricUnitError</a></div><div class="item-right docblock-short">An error parsing a <a href="enum.MetricUnit.html" title="MetricUnit"><code>MetricUnit</code></a> or one of its variants.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.ParseMetrics.html" title="relay_metrics::ParseMetrics struct">ParseMetrics</a></div><div class="item-right docblock-short">Iterator over parsed metrics returned from <a href="struct.Metric.html#method.parse_all" title="Metric::parse_all"><code>Metric::parse_all</code></a>.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.UnixTimestamp.html" title="relay_metrics::UnixTimestamp struct">UnixTimestamp</a></div><div class="item-right docblock-short">A unix timestamp (full seconds elapsed since 1970-01-01 00:00 UTC).</div></div></div><h2 id="enums" class="small-section-header"><a href="#enums">Enums</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.Aggregator.html" title="relay_metrics::Aggregator enum">Aggregator</a></div><div class="item-right docblock-short">Aggregator service interface.</div></div><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.BucketValue.html" title="relay_metrics::BucketValue enum">BucketValue</a></div><div class="item-right docblock-short">The <a href="struct.Bucket.html#structfield.value">aggregated value</a> of a metric bucket.</div></div><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.DurationUnit.html" title="relay_metrics::DurationUnit enum">DurationUnit</a></div><div class="item-right docblock-short">Time duration units used in <a href="enum.MetricUnit.html#variant.Duration" title="MetricUnit::Duration"><code>MetricUnit::Duration</code></a>.</div></div><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.FractionUnit.html" title="relay_metrics::FractionUnit enum">FractionUnit</a></div><div class="item-right docblock-short">Units of fraction used in <a href="enum.MetricUnit.html#variant.Fraction" title="MetricUnit::Fraction"><code>MetricUnit::Fraction</code></a>.</div></div><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.InformationUnit.html" title="relay_metrics::InformationUnit enum">InformationUnit</a></div><div class="item-right docblock-short">Size of information derived from bytes, used in <a href="enum.MetricUnit.html#variant.Information" title="MetricUnit::Information"><code>MetricUnit::Information</code></a>.</div></div><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.MetricNamespace.html" title="relay_metrics::MetricNamespace enum">MetricNamespace</a></div><div class="item-right docblock-short">The namespace of a metric.</div></div><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.MetricType.html" title="relay_metrics::MetricType enum">MetricType</a></div><div class="item-right docblock-short">The type of a <a href="enum.MetricValue.html" title="MetricValue"><code>MetricValue</code></a>, determining its aggregation and evaluation.</div></div><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.MetricUnit.html" title="relay_metrics::MetricUnit enum">MetricUnit</a></div><div class="item-right docblock-short">The unit of measurement of a metric value.</div></div><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.MetricValue.html" title="relay_metrics::MetricValue enum">MetricValue</a></div><div class="item-right docblock-short">The <a href="struct.Metric.html#structfield.value">typed value</a> of a metric.</div></div></div><h2 id="traits" class="small-section-header"><a href="#traits">Traits</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="trait" href="trait.MetricsContainer.html" title="relay_metrics::MetricsContainer trait">MetricsContainer</a></div><div class="item-right docblock-short">Common interface for <code>Metric</code> and <code>Bucket</code>.</div></div></div><h2 id="types" class="small-section-header"><a href="#types">Type Definitions</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="type" href="type.CounterType.html" title="relay_metrics::CounterType type">CounterType</a></div><div class="item-right docblock-short">Type used for Counter metric</div></div><div class="item-row"><div class="item-left module-item"><a class="type" href="type.DistributionType.html" title="relay_metrics::DistributionType type">DistributionType</a></div><div class="item-right docblock-short">Type of distribution entries</div></div><div class="item-row"><div class="item-left module-item"><a class="type" href="type.GaugeType.html" title="relay_metrics::GaugeType type">GaugeType</a></div><div class="item-right docblock-short">Type used for Gauge entries</div></div><div class="item-row"><div class="item-left module-item"><a class="type" href="type.SetType.html" title="relay_metrics::SetType type">SetType</a></div><div class="item-right docblock-short">Type used for set elements in Set metric</div></div></div></section></div></main><div id="rustdoc-vars" data-root-path="../" data-current-crate="relay_metrics" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.65.0 (897e37553 2022-11-02)" ></div></body></html>